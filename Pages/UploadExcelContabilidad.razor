@page "/uploadexcel-contabilidad"


@using System.Net.Http.Headers
@using System.Text.Json
@using System.Globalization
@using Microsoft.AspNetCore.Components.Forms

@inject HttpClient Http
@inject IJSRuntime JS

<div class="prinex-head">
    <h3>Contraste contabilidad ↔ Prinex</h3>
    <img class="prinex-logo" src="/Images/prinex_logo.png" alt="Prinex" />
</div>

<div class="prinex-desc">
    Cruza los datos de facturación de Prinex con los importes registrados en el libro mayor
</div>

<!-- Uploader unificado -->
<div class="df-uploader">
    <div class="df-filepick">
        <button type="button" class="btn btn-ghost df-filebtn">Seleccionar archivo (Excel)</button>
        <InputFile OnChange="OnFileSelected" accept=".xlsx,.xls" />
    </div>

    <div class="df-periodo">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <div class="input-group input-group-sm" style="width: 140px;">
                <span class="input-group-text bg-secondary text-white">Mes</span>
                <input type="number" min="1" max="12" @bind="_mes" class="form-control text-center" />
            </div>

            <div class="input-group input-group-sm" style="width: 160px;">
                <span class="input-group-text bg-secondary text-white">Año</span>
                <input type="number" min="2000" max="2100" @bind="_anio" class="form-control text-center" />
            </div>
        </div>
    </div>

    <button class="btn btn-primary" @onclick="Procesar" disabled="@(!_canSend || _busy)">
        @(_busy ? "Procesando..." : "Procesar")
    </button>
</div>

<!-- Dropzone -->
<div class="@($"df-drop df-drop--hero{(_drag ? " drag" : "")}")"
     @ondragover:preventDefault
     @ondragenter="() => SetDrag(true)"
     @ondragleave="() => SetDrag(false)"
     @ondrop="() => SetDrag(false)">

    <InputFile class="df-drop__input" OnChange="OnFileSelected" accept=".xlsx,.xls,.csv" />

    <div class="df-drop__icon"><i class="bi bi-file-earmark-spreadsheet"></i></div>

    <div class="df-drop__title">Arrastra aquí tu archivo</div>
    <div class="df-drop__hint">…o usa “Seleccionar archivo (Excel)”</div>
</div>

<!-- Estado archivo + mensajes (mismo look que cuadrepdfprinex) -->
@if (_selectedFile is not null || !string.IsNullOrWhiteSpace(_success) || !string.IsNullOrWhiteSpace(_error))
{
    <div class="df-status df-card card p-3 mt-3">

        <div class="df-files text-muted">
            @if (_selectedFile is not null)
            {
                <div><strong>Excel:</strong> @_selectedFile.Name</div>
            }
        </div>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <div class="alert alert-danger py-2 mt-3 mb-0">@_error</div>
        }
        @if (!string.IsNullOrWhiteSpace(_success))
        {
            <div class="alert alert-success py-2 mt-3 mb-0">@_success</div>
        }
    </div>
}

@if (_preview is not null)
{
    // Copiamos a una variable no-nullable para que el compilador deje de quejarse
    var model = _preview!;

    <div class="df-preview card df-card p-3 mt-3">
        <h5 class="mb-2">Resumen de comparación</h5>

        <!-- Faltantes -->
        <h6>⚠️ En Prinex pero NO en contabilidad (@(model.Faltantes?.Count ?? 0))</h6>
        <p class="df-section-subtitle">
            Facturas que aparecen como pendientes en Prinex pero no figuran en el libro mayor.
        </p>

        <table class="table table-sm table-striped table-hover" style="font-size:.85rem">
            <thead>
                <tr>
                    <th style="width:40%">Nº Factura</th>
                    <th style="width:60%">Importe PRINEX</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var f in model.Faltantes ?? new List<Faltante>())
                {
                    <tr>
                        <td>@f.Factura</td>
                        <td>@ToEuro(f.Importe)</td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- Descuadres -->
        <h6 class="mt-3">❌ Descuadres (@(model.Descuadres?.Count ?? 0))</h6>

        <p class="df-section-subtitle">
            Facturas presentes en Prinex y en el libro mayor, pero con importes distintos.
        </p>

        <table class="table table-sm table-striped table-hover" style="font-size:.85rem">
            <thead>
                <tr>
                    <th style="width:25%">Nº Factura</th>
                    <th style="width:25%">Importe PRINEX</th>
                    <th style="width:25%">Haber MAYORES</th>
                    <th style="width:25%">Diferencia</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var d in model.Descuadres ?? new List<Descuadre>())
                {
                    <tr>
                        <td>@d.Factura</td>
                        <td>@ToEuro(d.ImportePrinex)</td>
                        <td>@ToEuro(d.ImporteMayores)</td>
                        <td class="neg">@ToEuro(d.Diferencia)</td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- En MAYORES pero NO en Prinex -->
        @if (model.FaltantesInverso is not null)
        {
            <h6 class="mt-3">📒 En contabilidad pero NO en Prinex (@model.FaltantesInverso.Count)</h6>

            <p class="df-section-subtitle">
                Apuntes en contabilidad que no tienen factura pendiente asociada en Prinex.
            </p>

            <table class="table table-sm table-striped table-hover" style="font-size:.85rem">
                <thead>
                    <tr>
                        <th style="width:40%">Nº Factura</th>
                        <th style="width:60%">Importe MAYORES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var f in model.FaltantesInverso)
                    {
                        <tr>
                            <td>@f.Factura</td>
                            <td>@ToEuro(f.Importe)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

    <div class="text-muted small">
        Mostrando
        @((model.Faltantes?.Count ?? 0)
                + (model.Descuadres?.Count ?? 0)
                + (model.FaltantesInverso?.Count ?? 0))
        elementos.
    </div>
</div>
}


@code {
    // ---- Estado ----
    IBrowserFile? _selectedFile;
    bool _busy;
    int _mes = DateTime.Now.Month;
    int _anio = DateTime.Now.Year;

    bool _drag = false;
    bool _canSend => _selectedFile is not null;

    string? _success;
    string? _error;
    PreviewDto? _preview;

    // ---- Drag & Drop ----
    void HandleDragOver(DragEventArgs e)
    {
        _ = e.DataTransfer; // fuerza acceso
    }

    void SetDrag(bool v) => _drag = v;

    // ---- Selección ----
    void OnFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _success = _error = null;
        _preview = null;
    }

    // ---- Envío ----
    async Task Procesar()
    {
        if (_selectedFile is null) return;

        _busy = true; _success = _error = null; _preview = null;

        try
        {
            using var ms = new MemoryStream();
            await _selectedFile.OpenReadStream(maxAllowedSize: 20 * 1024 * 1024).CopyToAsync(ms);
            var bytes = ms.ToArray();

            using var content = new ByteArrayContent(bytes);
            content.Headers.ContentType = new MediaTypeHeaderValue(
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

            content.Headers.Add("X-File-Name", _selectedFile.Name);

            string apiUrl = $"http://localhost:7071/api/ProcesarExcel?mes={_mes}&anio={_anio}";

            var resp = await Http.PostAsync(apiUrl, content);

            if (!resp.IsSuccessStatusCode)
            {
                _error = await resp.Content.ReadAsStringAsync();
                if (string.IsNullOrWhiteSpace(_error)) _error = "Error al procesar el archivo.";
                return;
            }

            var outBytes = await resp.Content.ReadAsByteArrayAsync();
            var outName = GetFileNameFromContentDisposition(resp) ?? "Comparacion.xlsx";
            await JS.InvokeVoidAsync("downloadFileFromBytes", outName, Convert.ToBase64String(outBytes));

            _success = "Archivo procesado correctamente.";

            // Vista previa opcional vía cabecera X-Preview
            if (resp.Headers.TryGetValues("X-Preview", out var values))
            {
                var json = values.FirstOrDefault();
                if (!string.IsNullOrWhiteSpace(json))
                {
                    _preview = JsonSerializer.Deserialize<PreviewDto>(
                        json,
                        new JsonSerializerOptions { PropertyNameCaseInsensitive = true }
                    );
                }
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    // ---- Helpers ----
    static string ToEuro(double v) => v.ToString("C", new CultureInfo("es-ES"));

    static string? GetFileNameFromContentDisposition(HttpResponseMessage resp)
    {
        if (!resp.Content.Headers.TryGetValues("Content-Disposition", out var vals)) return null;
        var cd = vals.FirstOrDefault() ?? "";

        var starIdx = cd.IndexOf("filename*=", StringComparison.OrdinalIgnoreCase);
        if (starIdx >= 0)
        {
            var part = cd.Substring(starIdx + 10).Trim().Trim(';').Trim();
            var pos = part.IndexOf("''", StringComparison.Ordinal);
            if (pos > 0)
            {
                var enc = part.Substring(pos + 2).Trim('"');
                return Uri.UnescapeDataString(enc);
            }
        }

        var fnIdx = cd.IndexOf("filename=", StringComparison.OrdinalIgnoreCase);
        if (fnIdx >= 0)
        {
            var part = cd.Substring(fnIdx + 9).Trim().Trim(';').Trim().Trim('"');
            return part;
        }
        return null;
    }

    // ---- DTOs ----
    private class PreviewDto
    {
        public List<Faltante>? Faltantes { get; set; }
        public List<Descuadre>? Descuadres { get; set; }
        public List<FaltanteInv>? FaltantesInverso { get; set; }
    }

    private class Faltante
    {
        public string Factura { get; set; } = "";
        public double Importe { get; set; }
    }

    private class FaltanteInv
    {
        public string Factura { get; set; } = "";
        public double Importe { get; set; }
    }

    private class Descuadre
    {
        public string Factura { get; set; } = "";
        public double ImportePrinex { get; set; }
        public double ImporteMayores { get; set; }
        public double Diferencia { get; set; }
    }
}

<style>
    .neg {
        color: #b00000;
        font-weight: 600;
    }

    /* Bloque Excel + mensajes (mismo look que cuadrepdfprinex) */
    .df-status {
        margin-top: 1.5rem;
        background: #0f172a;
        border-radius: 0.75rem;
        border: 1px solid #1f2937;
        font-size: 0.9rem;
    }

        .df-status .df-files {
            margin-top: 0.5rem;
        }

            .df-status .df-files div + div {
                margin-top: 0.15rem;
            }

        .df-status .alert {
            margin-top: 0.6rem;
            margin-bottom: 0;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            display: inline-block;
            font-size: 0.85rem;
        }

    /* Tarjeta resumen */
    .df-preview {
        margin-top: 0.9rem;
    }

        .df-preview h5 {
            margin-top: 0;
            margin-bottom: 0.35rem;
        }

        .df-preview h6 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.15rem;
        }

    .df-section-subtitle {
        font-size: 0.85rem;
        color: #9ca3af;
        margin-top: 0.35rem; /* un pelín más separado del título */
        margin-bottom: 0.6rem; /* menos margen colapsado con la tabla */
    }
    /* Margen extra entre subtítulo y tabla de resultados */
    .df-preview table {
        margin-top: 0.55rem;
    }


</style>
