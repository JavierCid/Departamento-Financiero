@page "/desglose-facturas"
@inject HttpClient Http
@inject IJSRuntime JS

<div class="df-container">

    <!-- Cabecera PDFFlow -->
    <div class="pdf-head">
        <h3>Desglose de facturas</h3>
        <p class="pdf-desc">
            Procesa tus PDFs de facturas y genera automáticamente un Excel con el desglose listo para contabilidad.
        </p>
        <img class="pdf-logo" src="/Images/pdf_logo.png" alt="PDFFlow" />
    </div>

    <!-- Uploader superior (botón + procesar) -->
    <div class="df-uploader">
        <div class="df-filepick">
            <button type="button" class="btn btn-ghost df-filebtn">
                Seleccionar facturas (PDF)
            </button>
            <InputFile OnChange="OnFileSelected" accept=".pdf" />
        </div>

        <button class="btn btn-primary" @onclick="Upload" disabled="@(!canSend || busy)">
            @(busy ? "Procesando..." : "Procesar")
        </button>
    </div>

    <!-- Dropzone estilo BankFlow/PDFFlow -->
    <div class="@($"df-drop df-drop--hero{(drag ? " drag" : string.Empty)}")"
         @ondragover:preventDefault
         @ondragenter="() => SetDrag(true)"
         @ondragleave="() => SetDrag(false)"
         @ondrop="() => SetDrag(false)">

        <InputFile class="df-drop__input" OnChange="OnFileSelected" accept=".pdf" />

        <div class="df-drop__icon">
            <i class="bi bi-file-earmark-pdf"></i>
        </div>
        <div class="df-drop__title">Arrastra aquí tus facturas en PDF</div>
        <div class="df-drop__hint">…o usa “Seleccionar facturas (PDF)”</div>
    </div>

    <!-- Nombre del archivo -->
    @if (file is not null)
    {
        <div class="df-files">
            <div class="item">@file.Name</div>
        </div>
    }

    <!-- Mensajes -->
    @if (!string.IsNullOrWhiteSpace(okMsg))
    {
        <div class="alert alert-success mt-2">@okMsg</div>
    }
    @if (!string.IsNullOrWhiteSpace(errMsg))
    {
        <div class="alert alert-danger mt-2">@errMsg</div>
    }

    <!-- Vista previa (mismo modelo que antes, pero con tus estilos df-preview) -->
    @if (preview?.Lineas?.Count > 0)
    {
        <div class="df-preview card df-card p-3 mt-3">
            <h5>Vista previa (Desglose)</h5>

            <table class="table table-sm table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 140px;">Cuenta</th>
                        <th>Concepto</th>
                        <th style="width: 160px; text-align:right;">Importe</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var l in preview!.Lineas!)
                    {
                        <tr>
                            <td class="text-center">@l.Cuenta</td>
                            <td>@l.Concepto</td>
                            <td class="text-end">@l.Importe.ToString("N2")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code
{
    // ===== Estado UI =====
    IBrowserFile? file;
    bool busy;
    bool canSend => file is not null;
    string? okMsg;
    string? errMsg;

    bool drag;

    // ===== Modelo de vista previa (de X-Preview) =====
    PreviewDto? preview;

    sealed class PreviewDto
    {
        public List<PreviewLine>? Lineas { get; set; }
    }
    sealed class PreviewLine
    {
        public string Cuenta { get; set; } = "";
        public decimal Importe { get; set; }
        public string Concepto { get; set; } = "";
    }

    void OnFileSelected(InputFileChangeEventArgs e)
    {
        file = e.File;
        okMsg = errMsg = null;
        preview = null;
        StateHasChanged();
    }

    void SetDrag(bool value) => drag = value;

    async Task Upload()
    {
        if (file is null) return;

        okMsg = errMsg = null;
        preview = null;
        busy = true;
        try
        {
            // 1) Leer bytes del archivo
            using var ms = new MemoryStream();
            await file.OpenReadStream(long.MaxValue).CopyToAsync(ms);
            var bytes = ms.ToArray();

            // 2) Preparar petición → Function: /api/DesglosarFacturas (HTTP en local)
            var url = "http://localhost:7127/api/DesglosarFacturas";
            using var req = new HttpRequestMessage(HttpMethod.Post, url);
            var content = new ByteArrayContent(bytes);
            content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/octet-stream");
            req.Content = content;
            req.Headers.TryAddWithoutValidation("X-File-Name", file.Name);

            // 3) Enviar
            using var resp = await Http.SendAsync(req);

            // 4) Procesar respuesta
            if (!resp.IsSuccessStatusCode)
            {
                var msg = await resp.Content.ReadAsStringAsync();
                errMsg = $"Error {((int)resp.StatusCode)}: {msg}";
                return;
            }

            // Vista previa desde cabecera X-Preview (si viene)
            if (resp.Headers.TryGetValues("X-Preview", out var vals))
            {
                var json = vals.FirstOrDefault();
                if (!string.IsNullOrWhiteSpace(json))
                {
                    preview = System.Text.Json.JsonSerializer.Deserialize<PreviewDto>(json,
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                }
            }

            // 5) Descargar el Excel resultante
            var outBytes = await resp.Content.ReadAsByteArrayAsync();
            var outName = GetFileNameFromContentDisposition(resp) ?? $"Desglose_{System.IO.Path.GetFileName(file.Name)}";
            var base64 = Convert.ToBase64String(outBytes);
            await JS.InvokeVoidAsync("downloadFileFromBytes", outName, base64);

            okMsg = "Archivo procesado correctamente.";
        }
        catch (Exception ex)
        {
            errMsg = $"Error subiendo el archivo: {ex.Message}";
        }
        finally
        {
            busy = false;
        }
    }

    static string? GetFileNameFromContentDisposition(HttpResponseMessage resp)
    {
        // Soporta filename y filename* (UTF-8)
        if (resp.Content.Headers.ContentDisposition?.FileNameStar is string star && !string.IsNullOrWhiteSpace(star))
        {
            try
            {
                var idx = star.IndexOf("''", StringComparison.Ordinal);
                var encoded = idx >= 0 ? star[(idx + 2)..] : star;
                return Uri.UnescapeDataString(encoded.Trim('"'));
            }
            catch { }
        }

        var fn = resp.Content.Headers.ContentDisposition?.FileName;
        return string.IsNullOrWhiteSpace(fn) ? null : fn.Trim('"');
    }
}
