@page "/procesar-pdfs"
@page "/desglose-facturas"
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http
@using System.Net.Http.Headers
@inject HttpClient Http
@inject IJSRuntime JS

<div class="df-container">

    <!-- Cabecera PDFFlow -->
    <div class="pdf-head">
        <h3>Desglose de facturas</h3>
        <p class="pdf-desc">
            Procesa tus PDFs de facturas y genera automáticamente un Excel con el desglose listo para contabilidad
        </p>
        <img class="pdf-logo" src="/Images/pdf_logo.png" alt="PDFFlow" />
    </div>

    <!-- Uploader superior (botón + procesar) -->
    <div class="df-uploader">
        <div class="df-filepick">
            <button type="button" class="btn btn-ghost df-filebtn">
                Seleccionar facturas (PDF)
            </button>

            <InputFile OnChange="OnFileSelected" accept=".pdf" multiple />
        </div>

        <button class="btn btn-primary" @onclick="Upload" disabled="@(!canSend || busy)">
            @(busy ? "Procesando..." : "Procesar")
        </button>
    </div>

    <!-- Dropzone estilo BankFlow/PDFFlow -->
    <div class="@($"df-drop df-drop--hero{(drag ? " drag" : string.Empty)}")"
         @ondragover:preventDefault
         @ondragenter="() => SetDrag(true)"
         @ondragleave="() => SetDrag(false)"
         @ondrop="() => SetDrag(false)">

        <InputFile class="df-drop__input" OnChange="OnFileSelected" accept=".pdf" multiple />

        <div class="df-drop__icon">
            <i class="bi bi-file-earmark-pdf"></i>
        </div>
        <div class="df-drop__title">Arrastra aquí tus facturas en PDF</div>
        <div class="df-drop__hint">…o usa “Seleccionar facturas (PDF)”</div>
    </div>

    <!-- Lista de PDFs seleccionados -->
    @if (files.Count > 0)
    {
        <div class="df-files">
            <div class="item">
                <strong>PDFs cargados:</strong> @files.Count archivo(s)
            </div>
            <ul class="df-list">
                @foreach (var f in files)
                {
                    <li>@f.Name</li>
                }
            </ul>
        </div>
    }

    <!-- Mensajes -->
    @if (!string.IsNullOrWhiteSpace(okMsg))
    {
        <div class="alert alert-success df-alert">@okMsg</div>
    }
    @if (!string.IsNullOrWhiteSpace(errMsg))
    {
        <div class="alert alert-danger df-alert">@errMsg</div>
    }

    <!-- Vista previa tipo “antigua” (Muestra) -->
    @if (preview is not null && preview.Muestra.Count > 0)
    {
        <div class="df-preview card df-card p-3 mt-3">
            <h5 class="mb-3">Vista previa</h5>
            <table class="table table-sm table-striped table-hover" style="font-size:.95rem">
                <thead class="table-primary">
                    <tr>
                        <th>Archivo</th>
                        <th>Proveedor</th>
                        <th>Fecha</th>
                        <th>Invoice</th>
                        <th>Concepto</th>
                        <th class="text-end">Total Neto</th>
                        <th class="text-end">IVA €</th>
                        <th class="text-end">IRPF</th>
                        <th class="text-end">Total Bruto</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in preview.Muestra)
                    {
                        <tr>
                            <td><span title="@r.Archivo">@Trunc(r.Archivo, 27)</span></td>
                            <td><span title="@r.Proveedor">@Trunc(r.Proveedor, 27)</span></td>
                            <td>@r.Fecha</td>
                            <td>@r.Invoice</td>
                            <td>@r.Concepto</td>
                            <td class="text-end">@r.TotalNeto</td>
                            <td class="text-end">@r.IVA</td>
                            <td class="text-end">@r.IRPF</td>
                            <td class="text-end fw-semibold">@r.TotalBruto</td>
                        </tr>
                    }
                </tbody>
            </table>
            <div class="text-muted small">
                Mostrando @Math.Min(preview.Muestra.Count, 50) de @preview.Filas filas.
            </div>
        </div>
    }
    else if (!string.IsNullOrWhiteSpace(previewJson))
    {
        <h6 class="text-muted mt-3">Vista previa (modo texto)</h6>
        <pre style="white-space:pre-wrap">@previewJson</pre>
    }
</div>

@code
{
    // ===== Config =====
    // Ajusta el puerto al que usa tu main.py. Ahora mismo: 8010.
    const string EndpointPdf = "http://127.0.0.1:8000/api/pdf2excel";


    // ===== Estado UI =====
    List<IBrowserFile> files = new();
    bool busy;
    bool canSend => files.Count > 0;
    string? okMsg;
    string? errMsg;
    bool drag;

    string? previewJson;
    PreviewDto? preview;

    // ===== Modelos de vista previa (X-Preview de main.py) =====
    public class PreviewDto
    {
        public int Filas { get; set; }
        public List<Item> Muestra { get; set; } = new();

        public class Item
        {
            public string? Archivo { get; set; }
            public string? OCR { get; set; }
            public string? Proveedor { get; set; }
            public string? Fecha { get; set; }
            public string? Invoice { get; set; }
            public string? Concepto { get; set; }
            public string? TotalNeto { get; set; }   // "Total Neto"
            public string? IVA { get; set; }         // "IVA €"
            public string? IRPF { get; set; }        // "IRPF"
            public string? TotalBruto { get; set; }  // "Total Bruto"
        }
    }

    // ===== Eventos =====
    void OnFileSelected(InputFileChangeEventArgs e)
    {
        const int MaxPdfs = 50;
        files = e.GetMultipleFiles(MaxPdfs).ToList();

        okMsg = errMsg = null;
        preview = null;
        previewJson = null;
        StateHasChanged();
    }

    void SetDrag(bool value) => drag = value;

    async Task Upload()
    {
        if (files.Count == 0) return;

        okMsg = errMsg = null;
        preview = null;
        previewJson = null;
        busy = true;
        StateHasChanged();

        try
        {
            Console.WriteLine($"[Desglose] Inicio Upload. PDFs={files.Count}");

            using var form = new MultipartFormDataContent();

            foreach (var f in files)
            {
                Console.WriteLine($"[Desglose] Añadiendo fichero: {f.Name}, size={f.Size}");

                await using var stream = f.OpenReadStream(long.MaxValue);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var bytes = ms.ToArray();

                var fileContent = new ByteArrayContent(bytes);
                fileContent.Headers.ContentType = new MediaTypeHeaderValue("application/pdf");

                // Campo "file" → coincide con `file: List[UploadFile]` en main.py
                form.Add(fileContent, "file", f.Name);
            }

            form.Headers.Add("X-Client", "Departamento-Financiero");

            using var req = new HttpRequestMessage(HttpMethod.Post, EndpointPdf)
            {
                Content = form
            };
            req.Headers.Add("Accept", "application/json, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

            using var resp = await Http.SendAsync(req, HttpCompletionOption.ResponseHeadersRead);

            Console.WriteLine($"[Desglose] Respuesta {(int)resp.StatusCode} {resp.StatusCode}");

            if (!resp.IsSuccessStatusCode)
            {
                var msg = await resp.Content.ReadAsStringAsync();
                errMsg = $"Error {((int)resp.StatusCode)}: {msg}";
                Console.WriteLine($"[Desglose] Error respuesta: {errMsg}");
                return;
            }

            // X-Preview
            if (resp.Headers.TryGetValues("X-Preview", out var vals))
            {
                previewJson = vals.FirstOrDefault();
            }

            ParsePreviewIfAny();

            // Excel resultante
            var outBytes = await resp.Content.ReadAsByteArrayAsync();
            var outName = GetFileNameFromContentDisposition(resp)
                          ?? "Facturas_procesadas.xlsx";
            var base64 = Convert.ToBase64String(outBytes);
            await JS.InvokeVoidAsync("downloadFileFromBytes", outName, base64);

            okMsg = "Archivo procesado correctamente.";
            Console.WriteLine("[Desglose] Upload completado OK.");
            files.Clear();
        }
        catch (Exception ex)
        {
            errMsg = $"Error subiendo el archivo: {ex.GetType().Name}: {ex.Message}";
            Console.WriteLine($"[Desglose] EXCEPCIÓN en Upload: {ex}");
        }
        finally
        {
            busy = false;
            StateHasChanged();
        }
    }

    // ===== Utilidades =====
    static string? GetFileNameFromContentDisposition(HttpResponseMessage resp)
    {
        if (resp.Content.Headers.ContentDisposition?.FileNameStar is string star &&
            !string.IsNullOrWhiteSpace(star))
        {
            try
            {
                var idx = star.IndexOf("''", StringComparison.Ordinal);
                var encoded = idx >= 0 ? star[(idx + 2)..] : star;
                return Uri.UnescapeDataString(encoded.Trim('"'));
            }
            catch { }
        }
        var fn = resp.Content.Headers.ContentDisposition?.FileName;
        return string.IsNullOrWhiteSpace(fn) ? null : fn.Trim('"');
    }

    static string Trunc(string? s, int max) =>
        string.IsNullOrEmpty(s) ? "" : (s.Length <= max ? s : s.Substring(0, Math.Max(0, max - 3)) + "...");

    void ParsePreviewIfAny()
    {
        if (string.IsNullOrWhiteSpace(previewJson))
        {
            preview = null;
            return;
        }

        try
        {
            using var doc = System.Text.Json.JsonDocument.Parse(previewJson);
            var root = doc.RootElement;

            var dto = new PreviewDto
            {
                Filas = root.GetProperty("Filas").GetInt32()
            };

            foreach (var e in root.GetProperty("Muestra").EnumerateArray())
            {
                dto.Muestra.Add(new PreviewDto.Item
                {
                    Archivo    = e.TryGetProperty("Archivo", out var v0) ? v0.GetString() : null,
                    OCR        = e.TryGetProperty("OCR", out var v1) ? v1.GetString() : null,
                    Proveedor  = e.TryGetProperty("Proveedor", out var v2) ? v2.GetString() : null,
                    Fecha      = e.TryGetProperty("Fecha", out var v3) ? v3.GetString() : null,
                    Invoice    = e.TryGetProperty("Invoice", out var v4) ? v4.GetString() : null,
                    Concepto   = e.TryGetProperty("Concepto", out var v5) ? v5.GetString() : null,
                    TotalNeto  = e.TryGetProperty("Total Neto", out var v6) ? v6.GetString() : null,
                    IVA        = e.TryGetProperty("IVA €", out var v7) ? v7.GetString() : null,
                    IRPF       = e.TryGetProperty("IRPF", out var v8) ? v8.GetString() : null,
                    TotalBruto = e.TryGetProperty("Total Bruto", out var v9) ? v9.GetString() : null,
                });
            }

            preview = dto;
        }
        catch (System.Text.Json.JsonException ex)
        {
            errMsg = $"Error leyendo vista previa: {ex.Message}";
            Console.WriteLine($"[Desglose] Error deserializando X-Preview: {ex.Message}");
            Console.WriteLine($"[Desglose] X-Preview bruto: {previewJson}");
        }
    }
}
