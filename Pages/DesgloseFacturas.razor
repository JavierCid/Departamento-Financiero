@page "/procesar-pdfs"
@page "/desglose-facturas"
@inject HttpClient Http
@inject IJSRuntime JS
@using System.Net.Http
@using System.Net.Http.Headers

<div class="df-container">

    <!-- Cabecera PDFFlow -->
    <div class="pdf-head">
        <h3>Desglose de facturas</h3>
        <p class="pdf-desc">
            Procesa tus PDFs de facturas y genera automáticamente un Excel con el desglose listo para contabilidad
        </p>
        <img class="pdf-logo" src="/Images/pdf_logo.png" alt="PDFFlow" />
    </div>

    <!-- Uploader superior (botón + procesar) -->
    <div class="df-uploader">
        <div class="df-filepick">
            <button type="button" class="btn btn-ghost df-filebtn">
                Seleccionar facturas (PDF)
            </button>

            <InputFile OnChange="OnFileSelected" accept=".pdf" multiple />


        </div>

        <button class="btn btn-primary" @onclick="Upload" disabled="@(!canSend || busy)">
            @(busy ? "Procesando..." : "Procesar")
        </button>
    </div>

    <!-- Dropzone estilo BankFlow/PDFFlow -->
    <div class="@($"df-drop df-drop--hero{(drag ? " drag" : string.Empty)}")"
         @ondragover:preventDefault
         @ondragenter="() => SetDrag(true)"
         @ondragleave="() => SetDrag(false)"
         @ondrop="() => SetDrag(false)">

        <InputFile class="df-drop__input" OnChange="OnFileSelected" accept=".pdf" multiple />



        <div class="df-drop__icon">
            <i class="bi bi-file-earmark-pdf"></i>
        </div>
        <div class="df-drop__title">Arrastra aquí tus facturas en PDF</div>
        <div class="df-drop__hint">…o usa “Seleccionar facturas (PDF)”</div>
    </div>

    <!-- Lista de PDFs seleccionados -->
    @if (files.Count > 0)
    {
        <div class="df-files">
            <div class="item">
                <strong>PDFs cargados:</strong> @files.Count archivo(s)
            </div>
            <ul class="df-list">
                @foreach (var f in files)
                {
                    <li>@f.Name</li>
                }
            </ul>
        </div>
    }

    <!-- Mensajes -->
    @if (!string.IsNullOrWhiteSpace(okMsg))
    {
        <div class="alert alert-success df-alert">@okMsg</div>
    }
    @if (!string.IsNullOrWhiteSpace(errMsg))
    {
        <div class="alert alert-danger df-alert">@errMsg</div>
    }


    <!-- Vista previa -->
    @if (preview?.Lineas?.Count > 0)
    {
        <div class="df-preview card df-card p-3 mt-3">
            <h5>Vista previa (Desglose)</h5>

            <table class="table table-sm table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 180px;">Proveedor</th>
                        <th>Concepto</th>
                        <th style="width: 130px; text-align:right;">Importe neto</th>
                        <th style="width: 110px; text-align:right;">IVA</th>
                        <th style="width: 110px; text-align:right;">IRPF</th>
                        <th style="width: 130px; text-align:right;">Importe bruto</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var l in preview!.Lineas!)
                    {
                        <tr>
                            <td class="text-center">@l.Proveedor</td>

                            <td>@l.Concepto</td>
                            <td class="text-end">@($"{l.Neto:N2} €")</td>
                            <td class="text-end">@($"{l.IVA:N2} €")</td>
                            <td class="text-end">@($"{l.IRPF:N2} €")</td>
                            <td class="text-end">@($"{l.ImporteBruto:N2} €")</td>

                        </tr>

                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code
{
    // ===== Estado UI =====
    List<IBrowserFile> files = new();
    bool busy;
    bool canSend => files.Count > 0;
    string? okMsg;
    string? errMsg;
    bool drag;

    // ===== Modelo de vista previa (de X-Preview) =====
    PreviewDto? preview;

    sealed class PreviewDto
    {
        public List<PreviewLine>? Lineas { get; set; }
        // El resto de campos del JSON (Filas, Muestra, Errores) se ignoran si no los usamos
    }

    sealed class PreviewLine
    {
        public string Proveedor { get; set; } = "";
        public string Concepto { get; set; } = "";
        public decimal Neto { get; set; }
        public decimal IVA { get; set; }
        public decimal IRPF { get; set; }
        public decimal ImporteBruto { get; set; }
    }




    void OnFileSelected(InputFileChangeEventArgs e)
    {
        const int MaxPdfs = 50; // límite de PDFs
        files = e.GetMultipleFiles(MaxPdfs).ToList();

        okMsg = errMsg = null;
        preview = null;
        StateHasChanged();
    }

    void SetDrag(bool value) => drag = value;

    async Task Upload()
    {
        if (files.Count == 0) return;

        okMsg = errMsg = null;
        preview = null;
        busy = true;
        StateHasChanged();

        try
        {
            Console.WriteLine($"[Desglose] Inicio Upload. PDFs={files.Count}");

            // 1) Preparar multipart/form-data con TODOS los PDFs seleccionados
            var url = "http://127.0.0.1:8000/api/pdf2excel";

            using var form = new MultipartFormDataContent();

            foreach (var f in files)
            {
                Console.WriteLine($"[Desglose] Añadiendo fichero: {f.Name}, size={f.Size}");

                // 1) Leer el PDF completo en memoria (nos quitamos de encima el stream remoto de Blazor)
                await using var stream = f.OpenReadStream(long.MaxValue);
                using var ms = new System.IO.MemoryStream();
                await stream.CopyToAsync(ms);
                var bytes = ms.ToArray();

                // 2) Crear el contenido HTTP desde el byte[]
                var fileContent = new ByteArrayContent(bytes);
                fileContent.Headers.ContentType =
                    new MediaTypeHeaderValue("application/pdf");

                // 3) Campo "files" → es el que espera FastAPI (pdf2excel)
                form.Add(fileContent, "files", f.Name);
            }

            // HttpClient local, independiente de la inyección
            using var client = new HttpClient
            {
                Timeout = TimeSpan.FromMinutes(10)
            };

            Console.WriteLine($"[Desglose] Enviando POST a {url}");

            using var resp = await client.PostAsync(url, form);

            Console.WriteLine($"[Desglose] Respuesta {(int)resp.StatusCode} {resp.StatusCode}");


            // 2) Procesar respuesta
            if (!resp.IsSuccessStatusCode)
            {
                var msg = await resp.Content.ReadAsStringAsync();
                errMsg = $"Error {((int)resp.StatusCode)}: {msg}";
                Console.WriteLine($"[Desglose] Error respuesta: {errMsg}");
                return;
            }

            // 3) Vista previa desde cabecera X-Preview (si viene)
            if (resp.Headers.TryGetValues("X-Preview", out var vals))
            {
                var json = vals.FirstOrDefault();
                if (!string.IsNullOrWhiteSpace(json))
                {
                    try
                    {
                        preview = System.Text.Json.JsonSerializer.Deserialize<PreviewDto>(
                            json,
                            new System.Text.Json.JsonSerializerOptions
                            {
                                PropertyNameCaseInsensitive = true,
                                NumberHandling = System.Text.Json.Serialization.JsonNumberHandling.AllowReadingFromString
                            });
                    }
                    catch (System.Text.Json.JsonException ex)
                    {
                        // No rompas la subida: solo muestra el error y sigue.
                        errMsg = $"Error leyendo vista previa: {ex.Message}";
                        Console.WriteLine($"[Desglose] Error deserializando X-Preview: {ex.Message}");
                        Console.WriteLine($"[Desglose] X-Preview bruto: {json}");
                    }
                }
            }


            // 4) Descargar el Excel resultante
            var outBytes = await resp.Content.ReadAsByteArrayAsync();
            var outName = GetFileNameFromContentDisposition(resp)
                          ?? "Facturas_procesadas.xlsx";
            var base64 = Convert.ToBase64String(outBytes);
            await JS.InvokeVoidAsync("downloadFileFromBytes", outName, base64);

            okMsg = "Archivo procesado correctamente.";
            Console.WriteLine("[Desglose] Upload completado OK.");
        }
        catch (Exception ex)
        {
            errMsg = $"Error subiendo el archivo: {ex.GetType().Name}: {ex.Message}";
            Console.WriteLine($"[Desglose] EXCEPCIÓN en Upload: {ex}");
        }
        finally
        {
            busy = false;
            StateHasChanged();
        }
    }




    static string? GetFileNameFromContentDisposition(HttpResponseMessage resp)
    {
        // Soporta filename y filename* (UTF-8)
        if (resp.Content.Headers.ContentDisposition?.FileNameStar is string star &&
            !string.IsNullOrWhiteSpace(star))
        {
            try
            {
                var idx = star.IndexOf("''", StringComparison.Ordinal);
                var encoded = idx >= 0 ? star[(idx + 2)..] : star;
                return Uri.UnescapeDataString(encoded.Trim('"'));
            }
            catch { }
        }

        var fn = resp.Content.Headers.ContentDisposition?.FileName;
        return string.IsNullOrWhiteSpace(fn) ? null : fn.Trim('"');
    }
}
